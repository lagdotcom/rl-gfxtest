(()=>{var D;(function(e){e[e.None=0]="None",e[e.Blend=1]="Blend",e[e.Add=2]="Add"})(D||(D={}));function B(e,t,i,s){var n=arguments.length,o=n<3?t:s===null?s=Object.getOwnPropertyDescriptor(t,i):s,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(e,t,i,s);else for(var h=e.length-1;h>=0;h--)(r=e[h])&&(o=(n<3?r(o):n>3?r(t,i,o):r(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o}function c(e,t,i,s){return s===void 0&&(s=255),(e<<24)+(t<<16)+(i<<8)+s}var O={BLACK:c(0,0,0),WHITE:c(255,255,255),LIGHT_GRAY:c(170,170,170),DARK_GRAY:c(85,85,85),YELLOW:c(255,255,85),BROWN:c(170,85,0),LIGHT_RED:c(255,85,85),DARK_RED:c(170,0,0),LIGHT_GREEN:c(85,255,85),DARK_GREEN:c(0,170,0),LIGHT_CYAN:c(85,255,255),DARK_CYAN:c(0,170,170),LIGHT_BLUE:c(85,85,255),DARK_BLUE:c(0,0,170),LIGHT_MAGENTA:c(255,85,255),DARK_MAGENTA:c(170,0,170),ORANGE:c(255,136,0)},k=new Map;function S(e){k.set(e.name,e)}function z(e){return typeof e=="string"&&e.length>0?e.charCodeAt(0):e}var v=class{constructor(t,i,s,n,o){this.x=t,this.y=i,s!==void 0?this.charCode=z(s):this.charCode=" ".charCodeAt(0),n!==void 0?this.fg=n:this.fg=O.WHITE,o!==void 0?this.bg=o:this.bg=O.BLACK,this.dirty=!0,this.blocked=!1,this.blockedSight=!1,this.explored=!1,this.visible=!1,this.pathId=-1,this.g=0,this.h=0,this.prev=null}setCharCode(t){this.charCode!==t&&(this.charCode=t,this.dirty=!0)}setForeground(t){t!=null&&t!==this.fg&&(this.fg=t,this.dirty=!0)}setBackground(t){t!=null&&t!==this.bg&&(this.bg=t,this.dirty=!0)}setValue(t,i,s){return typeof t=="string"&&(t=t.charCodeAt(0)),typeof t=="number"?(this.setCharCode(t),i!==void 0&&this.setForeground(i),s!==void 0&&this.setBackground(s)):this.drawCell(t,D.None),this.dirty}drawCell(t,i){let s=t.bg&255;i===D.None||t.charCode>0?(this.setCharCode(t.charCode),this.setForeground(t.fg)):s>0&&s<255&&this.setForeground(this.blendColors(this.fg,t.bg,i)),i===D.None||s===255?this.setBackground(t.bg):s>0&&this.setBackground(this.blendColors(this.bg,t.bg,i))}blendColors(t,i,s){let o=(255-(i&255))/255,r=1-o,h=t>>24&255,u=t>>16&255,a=t>>8&255,l=i>>24&255,d=i>>16&255,f=i>>8&255;switch(s){case D.Blend:return c(o*h+r*l|0,o*u+r*d|0,o*a+r*f|0);case D.Add:return c(this.clamp(h+r*l|0),this.clamp(u+r*d|0),this.clamp(a+r*f|0));default:return i}}clamp(t){return Math.min(255,t)}};v=B([S],v);var T;(function(e){e[e.SMILEY=1]="SMILEY",e[e.INVERSE_SMILEY=2]="INVERSE_SMILEY",e[e.HEART=3]="HEART",e[e.DIAMOND=4]="DIAMOND",e[e.CLUB=5]="CLUB",e[e.SPADE=6]="SPADE",e[e.BULLET=7]="BULLET",e[e.INVERSE_BULLET=8]="INVERSE_BULLET",e[e.LIGHT_SHADE=176]="LIGHT_SHADE",e[e.MEDIUM_SHADE=177]="MEDIUM_SHADE",e[e.DARK_SHADE=178]="DARK_SHADE",e[e.BOX_SINGLE_VERTICAL=179]="BOX_SINGLE_VERTICAL",e[e.BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT=180]="BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT",e[e.BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT=185]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT",e[e.BOX_DOUBLE_VERTICAL=186]="BOX_DOUBLE_VERTICAL",e[e.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT=187]="BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT",e[e.BOX_DOUBLE_UP_AND_DOUBLE_LEFT=188]="BOX_DOUBLE_UP_AND_DOUBLE_LEFT",e[e.BOX_SINGLE_DOWN_AND_SINGLE_LEFT=191]="BOX_SINGLE_DOWN_AND_SINGLE_LEFT",e[e.BOX_SINGLE_UP_AND_SINGLE_RIGHT=192]="BOX_SINGLE_UP_AND_SINGLE_RIGHT",e[e.BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP=193]="BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP",e[e.BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN=194]="BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN",e[e.BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT=195]="BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT",e[e.BOX_SINGLE_HORIZONTAL=196]="BOX_SINGLE_HORIZONTAL",e[e.BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL=197]="BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL",e[e.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT=200]="BOX_DOUBLE_UP_AND_DOUBLE_RIGHT",e[e.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT=201]="BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT",e[e.BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP=202]="BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP",e[e.BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN=203]="BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN",e[e.BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT=204]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT",e[e.BOX_DOUBLE_HORIZONTAL=205]="BOX_DOUBLE_HORIZONTAL",e[e.BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL=206]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL",e[e.BOX_SINGLE_UP_AND_SINGLE_LEFT=217]="BOX_SINGLE_UP_AND_SINGLE_LEFT",e[e.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT=218]="BOX_SINGLE_DOWN_AND_SINGLE_RIGHT",e[e.BLOCK_FULL=219]="BLOCK_FULL",e[e.BLOCK_BOTTOM_HALF=220]="BLOCK_BOTTOM_HALF",e[e.BLOCK_LEFT_HALF=221]="BLOCK_LEFT_HALF",e[e.BLOCK_RIGHT_HALF=222]="BLOCK_RIGHT_HALF",e[e.BLOCK_TOP_HALF=223]="BLOCK_TOP_HALF"})(T||(T={}));function Q(e,t){let i=new RegExp("(\\S(.{0,"+t+"}\\S)?)\\s+","g");return(e+" ").replace(i,`$1
`).trim().split(`
`).map(s=>s.trim())}var H=class{constructor(t,i,s){this.width=t,this.height=i,this.grid=[],this.originX=0,this.originY=0,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.radius=0;for(let n=0;n<i;n++){let o=[];for(let r=0;r<t;r++)o.push(new v(r,n));this.grid.push(o)}if(this.clear(),s)for(let n=0;n<i;n++)for(let o=0;o<t;o++)this.grid[n][o].blocked=this.grid[n][o].blockedSight=s(o,n)}clear(){for(let t=0;t<this.height;t++)for(let i=0;i<this.width;i++)this.drawChar(i,t,0)}getCell(t,i){if(!(t<0||i<0||t>=this.width||i>=this.height))return this.grid[i][t]}getCharCode(t,i){if(!(t<0||i<0||t>=this.width||i>=this.height))return this.grid[i][t].charCode}drawChar(t,i,s,n,o){this.clip&&!this.clip.contains({x:t,y:i})||t>=0&&t<this.width&&i>=0&&i<this.height&&this.grid[i|0][t|0].setValue(s,n,o)}drawString(t,i,s,n,o){let r=s.split(`
`);for(let h=0;h<r.length;h++)this.drawStringLine(t,i+h,r[h],n,o)}drawStringLine(t,i,s,n,o){for(let r=0;r<s.length;r++)this.drawChar(t+r,i,s.charCodeAt(r),n,o)}drawCenteredString(t,i,s,n,o){this.drawString(t-Math.floor(s.length/2),i,s,n,o)}drawMessage(t,i,s,n){if(s.text){let o=Q(s.text,n||this.width-t);for(let r of o)this.drawStringLine(t,i,r,s.fg,s.bg),i++}if(s.children)for(let o of s.children)i=this.drawMessage(t,i,o,n);return i}drawHLine(t,i,s,n,o,r){for(let h=t;h<t+s;h++)this.drawChar(h,i,n,o,r)}drawVLine(t,i,s,n,o,r){for(let h=i;h<i+s;h++)this.drawChar(t,h,n,o,r)}drawRect(t,i,s,n,o,r,h){this.drawHLine(t,i,s,o,r,h),this.drawHLine(t,i+n-1,s,o,r,h),this.drawVLine(t,i,n,o,r,h),this.drawVLine(t+s-1,i,n,o,r,h)}drawBox(t,i,s,n,o,r,h,u,a,l,d,f,_,g){this.drawHLine(t,i,s,o,_,g),this.drawHLine(t,i+n-1,s,h,_,g),this.drawVLine(t,i,n,u,_,g),this.drawVLine(t+s-1,i,n,r,_,g),this.drawChar(t,i,a,_,g),this.drawChar(t+s-1,i,l,_,g),this.drawChar(t,i+n-1,f,_,g),this.drawChar(t+s-1,i+n-1,d,_,g)}drawSingleBox(t,i,s,n,o,r){this.drawBox(t,i,s,n,T.BOX_SINGLE_HORIZONTAL,T.BOX_SINGLE_VERTICAL,T.BOX_SINGLE_HORIZONTAL,T.BOX_SINGLE_VERTICAL,T.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT,T.BOX_SINGLE_DOWN_AND_SINGLE_LEFT,T.BOX_SINGLE_UP_AND_SINGLE_LEFT,T.BOX_SINGLE_UP_AND_SINGLE_RIGHT,o,r)}drawDoubleBox(t,i,s,n,o,r){this.drawBox(t,i,s,n,T.BOX_DOUBLE_HORIZONTAL,T.BOX_DOUBLE_VERTICAL,T.BOX_DOUBLE_HORIZONTAL,T.BOX_DOUBLE_VERTICAL,T.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT,T.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT,T.BOX_DOUBLE_UP_AND_DOUBLE_LEFT,T.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT,o,r)}fillRect(t,i,s,n,o,r,h){for(let u=i;u<i+n;u++)this.drawHLine(t,u,s,o,r,h)}drawConsole(t,i,s,n,o,r,h,u){u=u||D.None;for(let a=0;a<h;a++)for(let l=0;l<r;l++){let d=s.getCell(n+l,o+a);d&&this.drawCell(t+l,i+a,d,u)}}drawCell(t,i,s,n){t>=0&&t<this.width&&i>=0&&i<this.height&&this.grid[i][t].drawCell(s,n)}setBlocked(t,i,s){t>=0&&t<this.width&&i>=0&&i<this.height&&(this.grid[i][t].blocked=s)}setBlockedSight(t,i,s){t>=0&&t<this.width&&i>=0&&i<this.height&&(this.grid[i][t].blockedSight=s)}isVisible(t,i){return t<this.minX||t>this.maxX||i<this.minY||i>this.maxY?!1:this.grid[i][t].visible}isBlocked(t,i){return t<0||t>this.width||i<0||i>this.height?!0:this.grid[i][t].blocked}isBlockedSight(t,i){return t<0||t>this.width||i<0||i>this.height?!0:this.grid[i][t].blockedSight}computeOctantY(t,i){let s=[],n=[],o=1,r=0,h=0,u=0,a,l,d,f,_,g,m,R,L,p;for(l=this.originY+i;l>=this.minY&&l<=this.maxY;l+=i,h=r,++o)for(d=.5/o,p=-1,f=Math.floor(u*o+.5),a=this.originX+f*t;f<=o&&a>=this.minX&&a<=this.maxX;a+=t,++f,p=L){if(_=!0,g=!1,m=f/o,R=p,L=m+d,h>0){if(!(this.grid[l-i][a].visible&&!this.grid[l-i][a].blockedSight)&&!(this.grid[l-i][a-t].visible&&!this.grid[l-i][a-t].blockedSight))_=!1;else for(let A=0;A<h&&_;++A)if(R<=n[A]&&L>=s[A]){if(this.grid[l][a].blockedSight)if(R>=s[A]&&L<=n[A]){_=!1;break}else s[A]=Math.min(s[A],R),n[A]=Math.max(n[A],L),g=!0;else if(m>s[A]&&m<n[A]){_=!1;break}}}_&&(this.grid[l][a].visible=!0,this.grid[l][a].blockedSight&&(u>=R?u=L:g||(s[r]=R,n[r++]=L)))}}computeOctantX(t,i){let s=[],n=[],o=1,r=0,h=0,u=0,a,l,d,f,_,g,m,R,L,p;for(a=this.originX+t;a>=this.minX&&a<=this.maxX;a+=t,h=r,++o)for(d=.5/o,p=-1,f=Math.floor(u*o+.5),l=this.originY+f*i;f<=o&&l>=this.minY&&l<=this.maxY;l+=i,++f,p=L){if(_=!0,g=!1,m=f/o,R=p,L=m+d,h>0){if(!(this.grid[l][a-t].visible&&!this.grid[l][a-t].blockedSight)&&!(this.grid[l-i][a-t].visible&&!this.grid[l-i][a-t].blockedSight))_=!1;else for(let A=0;A<h&&_;++A)if(R<=n[A]&&L>=s[A]){if(this.grid[l][a].blockedSight)if(R>=s[A]&&L<=n[A]){_=!1;break}else s[A]=Math.min(s[A],R),n[A]=Math.max(n[A],L),g=!0;else if(m>s[A]&&m<n[A]){_=!1;break}}}_&&(this.grid[l][a].visible=!0,this.grid[l][a].blockedSight&&(u>=R?u=L:g||(s[r]=R,n[r++]=L)))}}computeFov(t,i,s,n,o){if(this.originX=t,this.originY=i,this.radius=s,n)this.minX=Math.min(this.minX,Math.max(0,t-s)),this.minY=Math.min(this.minY,Math.max(0,i-s)),this.maxX=Math.max(this.maxX,Math.min(this.width-1,t+s)),this.maxY=Math.max(this.maxY,Math.min(this.height-1,i+s));else{this.minX=Math.max(0,t-s),this.minY=Math.max(0,i-s),this.maxX=Math.min(this.width-1,t+s),this.maxY=Math.min(this.height-1,i+s);for(let r=this.minY;r<=this.maxY;r++)for(let h=this.minX;h<=this.maxX;h++)this.grid[r][h].visible=!1}this.grid[i][t].visible=!0,o===void 0?(this.computeOctantY(1,1),this.computeOctantX(1,1),this.computeOctantX(1,-1),this.computeOctantY(1,-1),this.computeOctantY(-1,-1),this.computeOctantX(-1,-1),this.computeOctantX(-1,1),this.computeOctantY(-1,1)):(o&1&&this.computeOctantY(1,1),o&2&&this.computeOctantX(1,1),o&4&&this.computeOctantX(1,-1),o&8&&this.computeOctantY(1,-1),o&16&&this.computeOctantY(-1,-1),o&32&&this.computeOctantX(-1,-1),o&64&&this.computeOctantX(-1,1),o&128&&this.computeOctantY(-1,1))}updateExplored(){for(let t=this.minY;t<=this.maxY;t++)for(let i=this.minX;i<=this.maxX;i++){let s=this.grid[t][i];s.explored=s.explored||s.visible}}};H=B([S],H);var P=class{constructor(t,i,s,n){this.url=t,this.charWidth=i,this.charHeight=s,this.scale=n||1}},j="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAQMAAAD58POIAAAABlBMVEUAAAD///+l2Z/dAAAEhklEQVRIx42Sv4oUQRDGC4UzadSwwMUD8QEKlbWD4Q58B/NGpTVocKO1wXHUzMAH0AcwMTYVGg5ag0IzEXaRjdZEZKNzkKbHqtnzHypY09M9+5uvqr7pbYCuC6ftaRhgONXs30eAh0O1rYDm4IS/eH0B8GxRW2vxo396yu/fb0ZFrW1zcOXlPU/XPwK8PGjbWhVwM4KnH61912oK4+zmmHJaQotyt1kvtC2Atdo24iohPDiG/v4eICJsY3Wy8Yvr0DSIBOdxgH6v8wsriWhc8s0AtaK/GzSl1jR0nSjQnwki6FQxNFKjgzO2a7BBqucH7dL4M9z96CIhT1Fs/AgKgcA6dKCxI29DaHNwRJ4EGAU1sU0OG9rmE4SIc3A4FChACqqhJRwpxkqh9wxag4DSmEJ5DtpFwAP4GUf6lmKcFFti1BYuQp4xN8kxM2kNhjdkTOiTUeAKGvhA1rLpMbYACQzCITlTDRMbLYoEa2JWPSMRFZIupcSzMVKcEUkX+sOG+ChNX2vD8ex6k7OFHL0P1655JuPd53WAD+yTv3UrCQiuHmYBbfIxpkImuvpBQBkVb5g4XHv3JkNireG8AO9zDhBZu2z2OMZ11S5/RIlyMefMNaZ4GsCz5xcjyM6hHYEjAYEfO8Ig1rklAe9sRIeYAdwyoIBq6YIzCAKiWoifA3m3o2AzWcdYKOdY47EIf8QABCuYgIUVmdVMEYEDA0Hmo/3D6KKJbh5mxhP3UsWIE97wnEygyizOfOLi2JOJW8CeOblW9IHeKZgv4zxuzDryOmb+4aQH+MXV6e0ywdUcxqCjBWl5GpbzZduOG1QEiGXP86T7EfiJfkMQ4OO4H0yqyNC2zlziWEN7Ywuc2fQ4p5BNkS5QYXP2h5NtRJh0vCKQidtVJmCGAwDSSQpYggSxiRIyzewsgCh4xxiTPDMh5aj//l7btqkr6rQyIOtLji4lVRQwXdzvus40Y53M33fh50GZwF4ExQeMlvuTggLzSi4ElKczUO7zVtpwdyMKdqZKOWb2nDblawPxPmuMwFEWBW+jlZR1eYtS442kiBGMWCi/h1/+GAR6NYOJWiqNJXFygFtrkx5C0O3IeFGs67HhEEhmBu/BUOT+0551pXxYIF+Elpi5AKRkLl5GUbCCZddyMv621ujEBPP4vSy2fotTx3U+d3WBiFOA6VSGSB49v/M7GBX9FPrDaT2c9qr4PCpwZ7qz813R94dVFIe19v33GlMZUghQFb8BrfE7QBmgBMbrn2B3enn/y3B5+DL8UBAdnejdYdBxeV9ejwoYNTgW0Ok/gA7UG2GAzanhL0DG7q4svynwF8UwDPu7u/vD0IudzSltMtVbP+J/gUbR29oJ7Fg9s6Uy+DnpiTCOYc4cXOeXMWfsusSw7FOg9x655nax6BlecwpOQQ68WBwp+H2LMQTuOq2RUigzh2Q/R3CWARJIJG199EwOTyKBlQMznshCRGeQ5gHABAQl6M4gLEdAzVaBWMCiANdsayDCHBA/hagKYfielrJIlipKKQIA9Nf3wBloTHT6BuAx15zRNa1nAAAAAElFTkSuQmCC",W=new P(j,8,8),M;(function(e){e[e.OCTANT_SOUTH_SOUTHEAST=1]="OCTANT_SOUTH_SOUTHEAST",e[e.OCTANT_EAST_SOUTHEAST=2]="OCTANT_EAST_SOUTHEAST",e[e.OCTANT_EAST_NORTHTHEAST=4]="OCTANT_EAST_NORTHTHEAST",e[e.OCTANT_NORTH_NORTHEAST=8]="OCTANT_NORTH_NORTHEAST",e[e.OCTANT_NORTH_NORTHWEST=16]="OCTANT_NORTH_NORTHWEST",e[e.OCTANT_WEST_NORTHEAST=32]="OCTANT_WEST_NORTHEAST",e[e.OCTANT_WEST_SOUTHWEST=64]="OCTANT_WEST_SOUTHWEST",e[e.OCTANT_SOUTH_SOUTHWEST=128]="OCTANT_SOUTH_SOUTHWEST"})(M||(M={}));var y;(function(e){e[e.QUADRANT_SOUTHEAST=3]="QUADRANT_SOUTHEAST",e[e.QUADRANT_EAST=6]="QUADRANT_EAST",e[e.QUADRANT_NORTHEAST=12]="QUADRANT_NORTHEAST",e[e.QUADRANT_NORTH=24]="QUADRANT_NORTH",e[e.QUADRANT_NORTHWEST=48]="QUADRANT_NORTHWEST",e[e.QUADRANT_WEST=96]="QUADRANT_WEST",e[e.QUADRANT_SOUTHWEST=192]="QUADRANT_SOUTHWEST",e[e.QUADRANT_SOUTH=129]="QUADRANT_SOUTH"})(y||(y={}));var x=class{constructor(t,i){this.x=t,this.y=i}};x=B([S],x);var U=class{constructor(t,i,s,n){this.x=this.left=t,this.y=this.top=i,this.width=s,this.height=n,this.x2=t+s,this.y2=i+n}getCenter(){return new x(this.x+this.width/2|0,this.y+this.height/2|0)}intersects(t){return this.x<=t.x2&&this.x2>=t.x&&this.y<=t.y2&&this.y2>=t.y}contains(t){return t.x>=this.x&&t.x<this.x2&&t.y>=this.y&&t.y<this.y2}};U=B([S],U);var X=class{constructor(t,i,s,n){this.text=t,this.fg=i,this.bg=s,this.children=n}getWidth(){let t=0;if(this.text)for(let i of this.text.split(`
`))t=Math.max(t,i.length);if(this.children)for(let i of this.children)t=Math.max(t,i.getWidth());return t}getHeight(){let t=0;if(this.text&&(t+=this.text.split(`
`).length),this.children)for(let i of this.children)t+=i.getHeight();return t}};X=B([S],X);var Z=200,q=1e3/15,F=class{constructor(){this.down=!1,this.downTime=0,this.repeat=!1,this.repeatTime=0,this.downCount=0,this.upCount=100}setDown(t){this.down!==t&&(this.down=t,this.repeat=!1,this.downTime=this.repeatTime=performance.now())}update(t){this.repeat=!1,this.down?(this.downCount++,this.upCount=0,t-this.downTime>=Z&&t-this.repeatTime>=q&&(this.repeat=!0,this.repeatTime=t)):(this.downCount=0,this.upCount++)}isPressed(){return this.downCount===1||this.repeat}isClicked(){return this.upCount===1}},b=class{constructor(){this.inputs=new Map}clear(){this.inputs.clear()}get(t){let i=this.inputs.get(t);return i||(i=new F,this.inputs.set(t,i)),i}updateAll(t){this.inputs.forEach(i=>i.update(t))}},G=class{constructor(t){this.keys=new b,t.addEventListener("keydown",i=>this.setKey(i,!0)),t.addEventListener("keyup",i=>this.setKey(i,!1))}clear(){this.keys.clear()}getKey(t){return this.keys.get(t)}setKey(t,i){let s=t.code;s!==E.VK_F11&&(t.stopPropagation(),t.preventDefault(),this.keys.get(s).setDown(i))}updateKeys(t){this.keys.updateAll(t)}},E;(function(e){e.VK_CANCEL="Pause",e.VK_BACKSPACE="Backspace",e.VK_TAB="Tab",e.VK_ENTER="Enter",e.VK_SHIFT_LEFT="ShiftLeft",e.VK_SHIFT_RIGHT="ShiftLeft",e.VK_CONTROL_LEFT="ControlLeft",e.VK_CONTROL_RIGHT="ControlRight",e.VK_ALT_LEFT="AltLeft",e.VK_ALT_RIGHT="AltRight",e.VK_PAUSE="Pause",e.VK_CAPS_LOCK="CapsLock",e.VK_ESCAPE="Escape",e.VK_SPACE="Space",e.VK_PAGE_UP="PageUp",e.VK_PAGE_DOWN="PageDown",e.VK_END="End",e.VK_HOME="Home",e.VK_LEFT="ArrowLeft",e.VK_UP="ArrowUp",e.VK_RIGHT="ArrowRight",e.VK_DOWN="ArrowDown",e.VK_INSERT="Insert",e.VK_DELETE="Delete",e.VK_0="Digit0",e.VK_1="Digit1",e.VK_2="Digit2",e.VK_3="Digit3",e.VK_4="Digit4",e.VK_5="Digit5",e.VK_6="Digit6",e.VK_7="Digit7",e.VK_8="Digit8",e.VK_9="Digit9",e.VK_SEMICOLON="Semicolon",e.VK_EQUALS="Equal",e.VK_A="KeyA",e.VK_B="KeyB",e.VK_C="KeyC",e.VK_D="KeyD",e.VK_E="KeyE",e.VK_F="KeyF",e.VK_G="KeyG",e.VK_H="KeyH",e.VK_I="KeyI",e.VK_J="KeyJ",e.VK_K="KeyK",e.VK_L="KeyL",e.VK_M="KeyM",e.VK_N="KeyN",e.VK_O="KeyO",e.VK_P="KeyP",e.VK_Q="KeyQ",e.VK_R="KeyR",e.VK_S="KeyS",e.VK_T="KeyT",e.VK_U="KeyU",e.VK_V="KeyV",e.VK_W="KeyW",e.VK_X="KeyX",e.VK_Y="KeyY",e.VK_Z="KeyZ",e.VK_CONTEXT_MENU="ContextMenu",e.VK_NUMPAD0="Numpad0",e.VK_NUMPAD1="Numpad1",e.VK_NUMPAD2="Numpad2",e.VK_NUMPAD3="Numpad3",e.VK_NUMPAD4="Numpad4",e.VK_NUMPAD5="Numpad5",e.VK_NUMPAD6="Numpad6",e.VK_NUMPAD7="Numpad7",e.VK_NUMPAD8="Numpad8",e.VK_NUMPAD9="Numpad9",e.VK_NUMPAD_ENTER="NumpadEnter",e.VK_MULTIPLY="NumpadMultiply",e.VK_ADD="NumpadAdd",e.VK_SEPARATOR="NumpadDecimal",e.VK_SUBTRACT="NumpadSubtract",e.VK_DECIMAL="NumpadDecimal",e.VK_DIVIDE="NumpadDivide",e.VK_F1="F1",e.VK_F2="F2",e.VK_F3="F3",e.VK_F4="F4",e.VK_F5="F5",e.VK_F6="F6",e.VK_F7="F7",e.VK_F8="F8",e.VK_F9="F9",e.VK_F10="F10",e.VK_F11="F11",e.VK_F12="F12",e.VK_F13="F13",e.VK_F14="F14",e.VK_F15="F15",e.VK_F16="F16",e.VK_F17="F17",e.VK_F18="F18",e.VK_F19="F19",e.VK_F20="F20",e.VK_F21="F21",e.VK_F22="F22",e.VK_F23="F23",e.VK_F24="F24",e.VK_NUM_LOCK="NumLock",e.VK_SCROLL_LOCK="ScrollLock",e.VK_COMMA="Comma",e.VK_PERIOD="Period",e.VK_SLASH="Slash",e.VK_BACKQUOTE="Backquote",e.VK_OPEN_BRACKET="BracketLeft",e.VK_BACK_SLASH="Backslash",e.VK_CLOSE_BRACKET="BracketRight",e.VK_QUOTE="Quote",e.VK_META="OSLeft"})(E||(E={}));var ft=[{charCode:T.BLOCK_TOP_HALF,active:[1,1,0,0]},{charCode:T.BLOCK_RIGHT_HALF,active:[0,1,0,1]}];var K=class{constructor(t){this.buttons=new b,this.el=t.canvas,this.width=t.width,this.height=t.height,this.prevX=0,this.prevY=0,this.x=0,this.y=0,this.dx=0,this.dy=0,this.wheelDeltaX=0,this.wheelDeltaY=0;let i=this.el;i.addEventListener("mousedown",s=>this.handleEvent(s)),i.addEventListener("mouseup",s=>this.handleEvent(s)),i.addEventListener("mousemove",s=>this.handleEvent(s)),i.addEventListener("contextmenu",s=>this.handleEvent(s)),i.addEventListener("touchstart",s=>this.handleTouchEvent(s)),i.addEventListener("touchend",s=>this.handleTouchEvent(s)),i.addEventListener("touchcancel",s=>this.handleTouchEvent(s)),i.addEventListener("touchmove",s=>this.handleTouchEvent(s)),i.addEventListener("wheel",s=>this.handleWheelEvent(s))}handleTouchEvent(t){if(t.stopPropagation(),t.preventDefault(),t.touches.length>0){let i=t.touches[0];this.updatePosition(i.clientX,i.clientY),this.buttons.get(0).setDown(!0)}else this.buttons.get(0).setDown(!1)}handleEvent(t){t.stopPropagation(),t.preventDefault(),this.updatePosition(t.clientX,t.clientY),t.type==="mousedown"&&(this.buttons.get(t.button).setDown(!0),this.el.focus()),t.type==="mouseup"&&this.buttons.get(t.button).setDown(!1)}handleWheelEvent(t){t.stopPropagation(),t.preventDefault(),this.wheelDeltaX=t.deltaX,this.wheelDeltaY=t.deltaY}updatePosition(t,i){let s=this.el.getBoundingClientRect(),n=this.width/this.height,o=s.width/s.height;if(o-n>.01){let r=n*s.height,h=s.width-r;s=new U(Math.floor(h/2),0,r,s.height)}if(o-n<-.01){let r=s.width/n,h=s.height-r;s=new U(0,Math.floor(h/2),s.width,r)}this.x=this.width*(t-s.left)/s.width|0,this.y=this.height*(i-s.top)/s.height|0}update(t){this.dx=this.x-this.prevX,this.dy=this.y-this.prevY,this.prevX=this.x,this.prevY=this.y,this.buttons.updateAll(t)}},dt={BLACK:c(0,0,0),WHITE:c(255,255,255),RED:c(136,0,0),CYAN:c(170,255,238),VIOLET:c(204,68,204),GREEN:c(0,204,85),BLUE:c(0,0,170),YELLOW:c(238,238,119),ORANGE:c(221,136,85),BROWN:c(102,68,0),LIGHT_RED:c(255,119,119),DARK_GRAY:c(51,51,51),GRAY:c(119,119,119),LIGHT_GREEN:c(170,255,102),LIGHT_BLUE:c(0,136,255),LIGHT_GRAY:c(187,187,187)},At={BLACK:c(0,0,0),WHITE:c(255,255,255),RED:c(136,0,0),CYAN:c(170,255,238),VIOLET:c(204,68,204),GREEN:c(0,204,85),BLUE:c(0,0,170),YELLOW:c(238,238,119),ORANGE:c(221,136,85),BROWN:c(102,68,0),LIGHT_RED:c(255,119,119),DARK_GRAY:c(51,51,51),GRAY:c(119,119,119),LIGHT_GREEN:c(170,255,102),LIGHT_BLUE:c(0,136,255),LIGHT_GRAY:c(187,187,187)},Et={BLACK:c(0,0,0),DARK_BLUE:c(29,43,83),DARK_PURPLE:c(126,37,83),DARK_GREEN:c(0,135,81),BROWN:c(171,82,54),DARK_GRAY:c(95,87,79),LIGHT_GRAY:c(194,195,199),WHITE:c(255,241,232),RED:c(255,0,77),ORANGE:c(255,163,0),YELLOW:c(255,236,39),GREEN:c(0,228,54),BLUE:c(41,173,255),LAVENDER:c(131,118,156),PINK:c(255,119,168),LIGHT_PEACH:c(255,204,170)};var C=class{constructor(t){this.m=2147483648,this.a=1103515245,this.c=12345,this.state=t||1}nextInt(){return this.state=(this.a*this.state+this.c)%this.m,this.state}nextFloat(){return this.nextInt()/(this.m-1)}nextRange(t,i){let s=i-t,n=this.nextInt()/this.m,o=t+(n*s|0);if(isNaN(o))throw new Error("rand nan");return o}chooseIndex(t){let i=t.reduce((o,r)=>o+r),s=this.nextRange(1,i+1),n=0;for(let o=0;o<t.length;o++)if(n+=t[o],s<=n)return o;return t.length-1}chooseKey(t){let i=Object.keys(t),s=i.map(n=>t[n]);return i[this.chooseIndex(s)]}};C=B([S],C);var J=`#version 300 es
precision highp float;in vec2 a;in vec2 b;in vec3 c;in vec3 d;out vec2 e;out vec4 f;out vec4 g;void main(void){gl_Position=vec4(a.x,a.y,0,1);e=b/16.0;f=vec4(c.r,c.g,c.b,1);g=vec4(d.r,d.g,d.b,1);}`,$=`#version 300 es
precision highp float;in vec2 e;in vec4 f;in vec4 g;uniform sampler2D s;out vec4 o;void main(void){o=texture(s,e);if(o.r<0.1) {o=g;} else {o=f;}}`,tt=`#version 300 es
precision highp float;
in vec2 a_position;
in vec2 a_texCoord;
out vec2 v_texCoord;
void main(void) {
  gl_Position=vec4(a_position.x, a_position.y, 0.0, 1.0);
  v_texCoord = a_texCoord;
}`,et=`#version 300 es
#define PI 3.1415926535897932384626433832795
precision highp float;
in vec2 v_texCoord;
uniform sampler2D u_texture;
uniform float u_blur;
uniform float u_curvature;
uniform float u_chroma;
uniform float u_scanlineWidth;
uniform float u_scanlineIntensity;
uniform float u_vignette;
out vec4 outputColor;

vec2 curve(vec2 uv) {
  uv = (uv - 0.5) * 2.0;
  uv *= 1.1;
  uv.x *= 1.0 + pow((abs(uv.y) * u_curvature), 2.0);
  uv.y *= 1.0 + pow((abs(uv.x) * u_curvature), 2.0);
  uv /= 1.1;
  uv = (uv / 2.0) + 0.5;
  return uv;
}

void main() {
  vec2 iResolution = vec2(640.0, 360.0);
  vec2 q = v_texCoord;
  vec2 fragCoord = v_texCoord;
  vec2 uv = q;
  uv = curve(uv);

  // Outside of range is black
  if (uv.x < 0.0 || uv.x > 1.0 || uv.y < 0.0 || uv.y > 1.0) {
    outputColor = vec4(0.0, 0.0, 0.0, 1.0);
    return;
  }

  vec4 col;

  // Chromatic aberration
  // col = texture(u_texture, uv.xy);
  col.r = 0.7 * texture(u_texture, vec2(uv.x + 0.001 * u_chroma, uv.y + 0.001 * u_chroma)).r;
  col.g = 0.7 * texture(u_texture, vec2(uv.x + 0.000 * u_chroma, uv.y - 0.002 * u_chroma)).g;
  col.b = 0.7 * texture(u_texture, vec2(uv.x - 0.002 * u_chroma, uv.y + 0.000 * u_chroma)).b;
  
  // Blur
  col += 0.05 * texture(u_texture, vec2(uv.x - 2.0 * u_blur / iResolution.x, uv.y));
  col += 0.10 * texture(u_texture, vec2(uv.x - 1.0 * u_blur / iResolution.x, uv.y));
  col += 0.10 * texture(u_texture, vec2(uv.x + 1.0 * u_blur / iResolution.x, uv.y));
  col += 0.05 * texture(u_texture, vec2(uv.x + 2.0 * u_blur / iResolution.x, uv.y));

  // Vignette
  col *= pow(16.0 * uv.x * uv.y * (1.0 - uv.x) * (1.0 - uv.y), u_vignette);

  // Scanlines
  col *= clamp(1.0 + u_scanlineWidth * sin(uv.y * iResolution.y * 2.0 * PI), 1.0 - u_scanlineIntensity, 1.0);

  outputColor = vec4(col.rgb, 1.0);
}`;function N(e,t){return-1+2*(e/t)}var it={font:W},V=class extends H{constructor(t,i,s,n){var o;super(i,s),n=n||it,this.canvas=t,this.font=n.font||W,this.crt=n.crt,this.maxFps=n.maxFps,this.pixelWidth=i*this.font.charWidth,this.pixelHeight=s*this.font.charHeight,this.pixelScale=((o=n.crt)===null||o===void 0?void 0:o.scale)||1,t.width=this.pixelWidth*this.pixelScale,t.height=this.pixelHeight*this.pixelScale,t.style.imageRendering="pixelated",t.style.outline="none",t.tabIndex=0,this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.keys=new G(t),this.mouse=new K(this);let r=t.getContext("webgl2",{antialias:!1});if(!r)throw new Error("Unable to initialize WebGL. Your browser may not support it.");let h=r.createProgram();if(!h)throw new Error("Unable to initialize WebGL. Your browser may not support it.");this.gl=r,this.program=h,r.attachShader(h,this.buildShader(r.VERTEX_SHADER,J)),r.attachShader(h,this.buildShader(r.FRAGMENT_SHADER,$)),r.linkProgram(h),r.useProgram(h),this.crtProgram=r.createProgram(),r.attachShader(this.crtProgram,this.buildShader(r.VERTEX_SHADER,tt)),r.attachShader(this.crtProgram,this.buildShader(r.FRAGMENT_SHADER,et)),r.linkProgram(this.crtProgram),r.useProgram(this.crtProgram),this.crtBlurLocation=r.getUniformLocation(this.crtProgram,"u_blur"),this.crtCurvatureLocation=r.getUniformLocation(this.crtProgram,"u_curvature"),this.crtChromaLocation=r.getUniformLocation(this.crtProgram,"u_chroma"),this.crtScanlineWidthLocation=r.getUniformLocation(this.crtProgram,"u_scanlineWidth"),this.crtScanlineIntensityLocation=r.getUniformLocation(this.crtProgram,"u_scanlineIntensity"),this.crtVignetteLocation=r.getUniformLocation(this.crtProgram,"u_vignette"),this.crtPositionLocation=r.getAttribLocation(this.crtProgram,"a_position"),this.crtPositionBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.crtPositionBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),r.STATIC_DRAW),r.enableVertexAttribArray(this.crtPositionLocation),r.vertexAttribPointer(this.crtPositionLocation,2,r.FLOAT,!1,0,0),this.crtTexCoordLocation=r.getAttribLocation(this.crtProgram,"a_texCoord"),this.crtTexCoordBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.crtTexCoordBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),r.STATIC_DRAW),r.enableVertexAttribArray(this.crtTexCoordLocation),r.vertexAttribPointer(this.crtTexCoordLocation,2,r.FLOAT,!1,0,0),this.positionAttribLocation=this.getAttribLocation("a"),this.textureAttribLocation=this.getAttribLocation("b"),this.fgColorAttribLocation=this.getAttribLocation("c"),this.bgColorAttribLocation=this.getAttribLocation("d");let u=i*s;this.positionsArray=new Float32Array(u*3*4),this.indexArray=new Uint16Array(u*6),this.textureArray=new Float32Array(u*2*4),this.foregroundUint8Array=new Uint8Array(u*4*4),this.foregroundDataView=new DataView(this.foregroundUint8Array.buffer),this.backgroundUint8Array=new Uint8Array(u*4*4),this.backgroundDataView=new DataView(this.backgroundUint8Array.buffer),this.frameBufferTexture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.frameBufferTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.pixelWidth,this.pixelHeight,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this.frameBuffer=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.frameBufferTexture,0);let a=0,l=0,d=0;for(let f=0;f<s;f++)for(let _=0;_<i;_++)this.positionsArray[a++]=N(_,i),this.positionsArray[a++]=-N(f,s),this.positionsArray[a++]=N(_+1,i),this.positionsArray[a++]=-N(f,s),this.positionsArray[a++]=N(_+1,i),this.positionsArray[a++]=-N(f+1,s),this.positionsArray[a++]=N(_,i),this.positionsArray[a++]=-N(f+1,s),this.indexArray[l++]=d+0,this.indexArray[l++]=d+1,this.indexArray[l++]=d+2,this.indexArray[l++]=d+0,this.indexArray[l++]=d+2,this.indexArray[l++]=d+3,d+=4;this.positionBuffer=r.createBuffer(),this.indexBuffer=r.createBuffer(),this.textureBuffer=r.createBuffer(),this.foregroundBuffer=r.createBuffer(),this.backgroundBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer),r.bufferData(r.ARRAY_BUFFER,this.positionsArray,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,this.indexArray,r.STATIC_DRAW),this.texture=this.loadTexture(this.font.url),this.lastRenderTime=0,this.renderDelta=0,this.fps=0,this.averageFps=0,this.maxFps===void 0?this.requestAnimationFrame():window.setInterval(()=>this.renderLoop(performance.now()),1e3/this.maxFps)}handleResize(){let t=this.canvas.parentElement;if(!t)return;let i=t.offsetWidth/this.pixelWidth,s=t.offsetHeight/this.pixelHeight,n=Math.min(i,s),o=n*this.pixelWidth|0,r=n*this.pixelHeight|0;this.canvas.style.width=o+"px",this.canvas.style.height=r+"px"}getAttribLocation(t){let i=this.gl.getAttribLocation(this.program,t);return this.gl.enableVertexAttribArray(i),i}flush(){let t=0,i=0;for(let s=0;s<this.height;s++)for(let n=0;n<this.width;n++){let o=this.getCell(n,s);if(!o.dirty){t+=8,i+=16;continue}let r=o.charCode%16,h=o.charCode/16|0;this.textureArray[t++]=r,this.textureArray[t++]=h,this.textureArray[t++]=r+1,this.textureArray[t++]=h,this.textureArray[t++]=r+1,this.textureArray[t++]=h+1,this.textureArray[t++]=r,this.textureArray[t++]=h+1;for(let u=0;u<4;u++)this.foregroundDataView.setUint32(i,o.fg,!1),this.backgroundDataView.setUint32(i,o.bg,!1),i+=4;o.dirty=!1}}isKeyDown(t){return this.keys.getKey(t).down}isKeyPressed(t){return this.keys.getKey(t).isPressed()}getKeyDownCount(t){return this.keys.getKey(t).downCount}getMovementKey(){if(this.isKeyPressed(E.VK_NUMPAD1)||this.isKeyPressed(E.VK_B))return new x(-1,1);if(this.isKeyPressed(E.VK_NUMPAD2)||this.isKeyPressed(E.VK_J)||this.isKeyPressed(E.VK_DOWN))return new x(0,1);if(this.isKeyPressed(E.VK_NUMPAD3)||this.isKeyPressed(E.VK_N))return new x(1,1);if(this.isKeyPressed(E.VK_NUMPAD4)||this.isKeyPressed(E.VK_H)||this.isKeyPressed(E.VK_LEFT))return new x(-1,0);if(this.isKeyPressed(E.VK_NUMPAD5)||this.isKeyPressed(E.VK_PERIOD))return new x(0,0);if(this.isKeyPressed(E.VK_NUMPAD6)||this.isKeyPressed(E.VK_L)||this.isKeyPressed(E.VK_RIGHT))return new x(1,0);if(this.isKeyPressed(E.VK_NUMPAD7)||this.isKeyPressed(E.VK_Y))return new x(-1,-1);if(this.isKeyPressed(E.VK_NUMPAD8)||this.isKeyPressed(E.VK_K)||this.isKeyPressed(E.VK_UP))return new x(0,-1);if(this.isKeyPressed(E.VK_NUMPAD9)||this.isKeyPressed(E.VK_U))return new x(1,-1)}buildShader(t,i){let s=this.gl,n=s.createShader(t);if(!n)throw new Error("An error occurred compiling the shader: ");if(s.shaderSource(n,i),s.compileShader(n),!s.getShaderParameter(n,s.COMPILE_STATUS))throw new Error("An error occurred compiling the shader: "+s.getShaderInfoLog(n));return n}loadTexture(t){let i=this.gl,s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s);let n=0,o=i.RGBA,r=1,h=1,u=0,a=i.RGBA,l=i.UNSIGNED_BYTE,d=new Uint8Array([0,0,0,255]);i.texImage2D(i.TEXTURE_2D,n,o,r,h,u,a,l,d);let f=new Image;return f.onload=()=>{i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,n,o,a,l,f),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR)},f.src=t,s}render(){let t=this.gl;t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this.crt?t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,this.pixelWidth,this.pixelHeight);{let s=t.FLOAT,n=!1,o=0,r=0;t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.vertexAttribPointer(this.positionAttribLocation,2,s,n,o,r)}{let s=t.FLOAT,n=!1,o=0,r=0;t.bindBuffer(t.ARRAY_BUFFER,this.textureBuffer),t.bufferData(t.ARRAY_BUFFER,this.textureArray,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.textureAttribLocation,2,s,n,o,r)}{let s=t.UNSIGNED_BYTE,n=!0,o=0,r=0;t.bindBuffer(t.ARRAY_BUFFER,this.foregroundBuffer),t.bufferData(t.ARRAY_BUFFER,this.foregroundUint8Array,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.fgColorAttribLocation,4,s,n,o,r)}{let s=t.UNSIGNED_BYTE,n=!0,o=0,r=0;t.bindBuffer(t.ARRAY_BUFFER,this.backgroundBuffer),t.bufferData(t.ARRAY_BUFFER,this.backgroundUint8Array,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.bgColorAttribLocation,4,s,n,o,r)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.useProgram(this.program),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture);{let i=this.width*this.height*6,s=t.UNSIGNED_SHORT,n=0;t.drawElements(t.TRIANGLES,i,s,n)}}renderCrt(){let t=this.crt;if(!t)return;let i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,this.pixelWidth*this.pixelScale,this.pixelHeight*this.pixelScale),i.useProgram(this.crtProgram),i.uniform1f(this.crtBlurLocation,t.blur),i.uniform1f(this.crtCurvatureLocation,t.curvature),i.uniform1f(this.crtChromaLocation,t.chroma),i.uniform1f(this.crtVignetteLocation,t.vignette),i.uniform1f(this.crtScanlineWidthLocation,t.scanlineWidth),i.uniform1f(this.crtScanlineIntensityLocation,t.scanlineIntensity),i.bindBuffer(i.ARRAY_BUFFER,this.crtPositionBuffer),i.vertexAttribPointer(this.crtPositionLocation,2,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this.crtTexCoordBuffer),i.vertexAttribPointer(this.crtTexCoordLocation,2,i.FLOAT,!1,0,0),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.frameBufferTexture),i.drawArrays(i.TRIANGLES,0,6)}requestAnimationFrame(){window.requestAnimationFrame(t=>this.renderLoop(t))}renderLoop(t){this.lastRenderTime===0?(this.lastRenderTime=t,this.fps=0):(this.renderDelta=t-this.lastRenderTime,this.lastRenderTime=t,this.fps=1e3/this.renderDelta,this.averageFps=.95*this.averageFps+.05*this.fps),this.keys.updateKeys(t),this.mouse.update(t),this.update&&this.update(),this.flush(),this.render(),this.crt&&this.renderCrt(),this.maxFps===void 0&&this.requestAnimationFrame()}};function I(e){return Math.round(e)}function Y(e,t,i){return(1-i)*e+i*t}function st(e){if(e<0)return O.BLACK;if(e>8)return O.WHITE;if(e>=4){let o=(e-4)/4,r=Y(0,255,o);return c(r,255,255)}let t=e/4,i=0,s=Y(0,255,t);return c(i,s,i)}function rt(e,t,i){let s=I(e),n=I(t),o=Math.cos(i),r=Math.sin(i),h=e,u=t;for(;;)if(h+=o,u+=r,I(h)!=s||I(u)!=n)return[h,u]}function nt(e,t){return e*1e3+t}function ot(e){return[Math.floor(e/1e3),e%1e3]}var w=class{constructor(t,i,s,n=20){this.term=t;this.x=i;this.y=s;this.power=n;this.rng=new C(Date.now()),this.values=new Map}poke(t,i,s){let n=nt(I(t),I(i)),o=this.values.get(n);this.values.set(n,Math.max(o||0,s))}draw(){this.values.clear();let t=this.rng.nextFloat()*3,i=this.rng.nextRange(3,5);for(let s=0;s<i;s++)this.arc(this.x,this.y,this.power/i,t,(this.rng.nextFloat()-.5)/3),t+=1+this.rng.nextFloat()*2;for(let[s,n]of this.values){let[o,r]=ot(s);this.term.drawChar(o,r," ",void 0,st(n))}}arc(t,i,s,n,o){if(s<=0)return;this.poke(t,i,s),n+=o;let[r,h]=rt(t,i,n);if(this.rng.nextFloat()<.2){let a=this.rng.nextFloat();s*=.6,this.arc(r,h,s,n-a,-o),n+=a}let u=this.rng.nextFloat();this.arc(r,h,s-u,n,o)}};function ht(e){let s=document.createElement("div");e.appendChild(s);let n=()=>{let d=Math.floor(window.innerWidth/480),f=Math.floor(window.innerHeight/320),_=Math.min(d,f);s.style.width=`${480*_}px`,s.style.height=`${320*_}px`};window.addEventListener("resize",n),n();let o=document.createElement("canvas");s.appendChild(o);let r=new V(o,60,40,{maxFps:10}),h=new w(r,60/2,40/2),u=O.WHITE;r.update=()=>{r.fillRect(0,0,60,40," ",void 0,0),h.draw(),r.drawCenteredString(60/2,4,"!! ELECTRO RAVE !!",u),u=u===O.WHITE?O.LIGHT_CYAN:O.WHITE}}window.addEventListener("load",()=>ht(document.body));})();
